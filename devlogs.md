# 移动音乐播放应用-开发文档

## 一、技术选型说明

### 移动端

#### 1、开屏广告

打开程序后跳转到StartAd页面，它是一个启动广告页面，展示广告图片并进行5秒倒计时，在倒计时结束后或用户点击跳过广告时，会跳转到首页，点击广告图片则会跳转到WebView页面。

网页页面使用WebView组件，展示广告链接对应的页面，需要重写onBackPress()方法，确保返回时是回到应用的主页面。

#### 2、登录注册

为了每次登录记住用户的用户名，定义了一个`PreferencesManager`类，用于管理应用的偏好设置数据。

- 类中有一个`preferences`属性，用于存储偏好设置实例，初始值为`null`。
- `init`方法用于初始化偏好设置实例，接收`context`和`name`参数，通过`dataPreferences.getPreferences`方法获取偏好设置实例并赋值给`preferences`属性。
- `getPreferences`方法返回当前的偏好设置实例。
- `get`方法用于获取指定键`key`的值，如果`preferences`实例已初始化，则调用其`get`方法获取值，否则输出错误信息并返回默认值`defaultValue`。
- `put`方法用于存储键值对，如果`preferences`实例已初始化，则调用其`put`方法存储数据，并在回调中处理成功或失败的情况，否则输出错误信息。
- `flush`方法用于将数据持久化到文件，如果`preferences`实例已初始化，则调用其`flush`方法进行持久化操作，并在回调中处理成功或失败的情况，否则输出错误信息。

**UserLogin**页面加载时通过`aboutToAppear`方法初始化偏好设置管理器，并尝试从偏好设置中获取保存的用户名，将其赋值给页面的用户名输入框绑定变量。 `handleLogin`方法，使用`userLogin` API 发起登录请求。该API会将后端返回的Token存储在AppStorage中，在之后的所有请求都会在`headers`中添加

**Token字段**，用于与后端配合鉴权（具体见/api/request.ets）。登录成功后，将用户名存储到偏好设置中并持久化，确保每次登录预填的用户名都是最近使用的。

**UserRegister**页面同理，在注册成功后通过`flush`操作更新用户名。

#### 3、音乐播放/历史记录存储

**AVPlayerManager类**

音乐播放功能的实现主要使用Media Kit中的**AVPlayer**，通过调用AVPlayer提供的初始化、加载音乐、音乐控制等方法实现对音乐的播放

为了实现全局统一的音乐播放管理，定义了**AVPlayerManager**类。

- 该类属于单例，用户可以通过调用`getInstance()`方法来获取该实例，确保管理的全局唯一
- 设置一些音乐播放的回调函数，例如音乐进度变化或加载新的音乐。用户可以调用`setTimeUpdateCallBack`和`setPrepareCallBack`来动态设置这些回调函数
- 封装了一些常用的音乐播放方法，将多个AVPlayer方法整合，例如`setMusicList`方法可以设置播放列表并自动开始播放音乐，`setStrategy`方法切换播放策略，`jumpToNextMusic`和`jumpToPrevMusic`切换下一首上一首等，以及暂停继续、设置播放进度等

错误处理：

- 在每个音乐播放函数中会检查当前avplayer实例是否存在；针对边界情况如播放列表没有歌曲、传递的参数超出范围等都进行了相应处理，

- 在发生错误的时候会调用error回调函数，并通过`avplayer.reset`方法重置播放器，实现错误及时恢复

**DatabaseManager类**

音乐播放时，会自动保存音乐的历史记录。音乐历史记录使用ArkData提供的关系型数据库SQLite来存储。

为了实现统一的历史记录存储，定义了**DatabaseManager**类，封装了历史记录保存读取和删除函数

- 历史记录的保存读取和删除使用**TaskPool**机制，为函数添加@Concurrent装饰器，实现多任务并发。
- 历史记录保存时将历史记录按顺序存储进SQLite中，当历史记录数量超过上限时会删除最早的历史记录。

音乐播放时，会自动调用DatabaseManager类提供的`saveMusicHistory`方法，实现自动历史记录存储

错误处理：

- 针对历史记录重复、超出范围等特殊情况进行处理
- 针对getRdbStore失败、回调函数异常等都进行了处理
- 获取历史记录时通过reject来表示获取失败情况，并在所有可能出错的位置都使用了catch，捕获错误信息，避免崩溃

#### 4、播放栏

主要功能

- **音乐信息展示**：显示当前播放的音乐封面、歌名和歌手；点击封面或音乐名称可进入音乐详情页面。
- **播放顺序切换**：通过图标展示当前的播放顺序策略，点击图标可切换播放策略。
- **控制按钮**：提供上一首、下一首的按钮，以及播放/暂停的功能按钮。
- **播放列表**：点击播放列表图标弹出一个气泡窗口，显示当前播放列表。
- **进度条控制**：显示当前播放进度的进度条，支持用户拖动调整进度。

实现细节

- **数据绑定**：
  当前播放的音乐、播放策略等信息保存在 `AppStorage` 中，由 `AVPlayerManager` 负责统一管理。播放栏组件通过 `@StorageProp` 将这些数据与 UI 绑定，确保信息实时更新。
- **进度条**：
  使用 `Slider` 组件实现播放进度条，同样通过 `@StorageProp` 绑定数据。当用户拖动进度条时，触发 `onChange` 函数，修改播放进度。

#### 5、推荐页面

**数据传输**

- 在aboutToAppear中顺序请求推荐的曲目、歌单数据，供组件调用。

**推荐内容展示**

- **推荐歌曲轮播图**：展示推荐歌曲的封面图片，轮播图自动播放并循环展示。每张封面都可以点击，点击后会调用`playSong`方法开始播放对应的歌曲。
- **推荐歌曲列表**：列出推荐歌曲的详细信息，包括歌曲封面、歌名、歌手。若列表不为空，用户可以点击某一首歌曲进行播放，并跳转到歌曲详情页面。若列表为空，显示“获取推荐歌曲中...”的提示，表示歌曲数据正在加载中。
- **推荐歌单列表**：展示推荐歌单的封面图标及名称，用户点击歌单图标后可以跳转至歌单详情页。每个歌单图标都是圆形，点击后会通过路由跳转，参数中包含歌单的ID。若歌单列表为空，显示“获取推荐歌单中...”的提示，表示歌单数据正在加载中。

**布局设计**

- 使用了`Column`和`Row`布局，确保推荐歌曲和歌单内容按顺序展示，并且具有适当的间隔和对齐方式。
- 混合使用Vertical与Horizontal的Scroll滚动条布局，同时滚动条设为Off以提升页面美观度。

**异常处理**

- 当推荐歌曲或歌单为空时，页面会显示相应的加载提示，避免空白页面的出现。
- 当推荐信息获取失败时，产生醒目提示与日志输出。

#### 6、歌单相关模块

**Detail 页面**

主要功能：

- 展示当前音乐信息
- 提供音乐的播放控制（播放、暂停、跳转等）
- 允许用户选择播放策略（顺序播放、随机播放、循环播放）
- 显示自建歌单列表，允许将当前音乐添加到歌单中

交互流程

- **播放控制**：
  - 用户点击播放按钮后，调用 `avPlayer?.continue()`，继续播放当前音乐。
  - 点击暂停按钮时，调用 `avPlayer?.pause()`，暂停当前播放。
  - 进度条显示当前播放的时间，通过 `Slider()` 控件实现，用户可以拖动进度条来调整音乐播放位置。

- **播放策略切换**：
  - 通过点击播放策略按钮，调用 `changeStrategy()` 来切换播放策略。
  - `MusicPlayStrategy.SEQUENCE` 表示顺序播放，`RANDOM` 表示随机播放，`LOOP` 表示循环播放。

- **歌单管理**：
  - 点击 “添加到歌单” 按钮后，会弹出歌单选择弹窗，展示所有自建歌单
  - 用户可以选择一个歌单，将当前音乐添加到该歌单中

**PlayListPage 页面**

主要功能

- 展示自建歌单：从服务器获取并展示用户自建的歌单列表。
- 展示收藏歌单：从服务器获取并展示用户收藏的歌单列表。
- 跳转至歌单详情页：点击某个歌单项时，跳转至该歌单的详情页，并传递歌单 ID。

交互流程

- **歌单列表展示**：
  - 页面加载时，通过 `aboutToAppear()` 方法获取用户的自建歌单 ID（`listIds`）和收藏歌单 ID（`favoriteIds`）。
  - 依据获取的歌单 ID，分别调用 `getPlayListById()` 请求获取自建歌单和收藏歌单的详细信息。
  - 请求成功后，将返回的歌单数据分别存储在 `playlists` 和 `favplaylists` 状态变量中，并渲染到页面。
  - 如果用户没有歌单，页面会展示 "暂无歌单" 的提示信息。

- **Tab切换功能**：
  - 页面提供两个 Tab，分别用于展示自建歌单和收藏歌单。
  - 用户点击不同的 Tab 来切换页面内容。Tab 的样式由 `tabBuilder()` 自定义。
  - 当前选中的 Tab 会通过 `currentIndex` 状态变量来控制。
  - 点击 Tab 时，`onChange()` 事件监听器会更新 `currentIndex`，切换展示内容。

- **歌单项展示**：
  - 每个歌单项展示歌单的封面图和歌单名称。
  - 用户点击歌单项时，页面会跳转到歌单详情页，传递当前歌单的 ID 作为参数。
  - 如果歌单数据尚未加载完成，会显示 "加载中..." 的提示信息。

- **创建歌单按钮**：
  - 页面右下角有一个圆形 "添加" 按钮。
  - 用户点击该按钮时，将跳转到 `CreatePlayList` 页面，允许用户创建新的歌单。

**PlayListDetail 页面**

主要功能：

- 展示当前歌单信息（如封面、名称等）
- 提供音乐的播放控制（播放、暂停、跳转等）
- 允许用户进行歌单管理（删除歌曲、收藏/取消收藏歌单等）
- 显示歌单中的歌曲列表，并允许将歌曲添加到播放队列中

UI组件与交互流程

- **播放控制**：
  - 用户点击歌单中的歌曲时，调用 `AVPlayerManager` 播放选中的歌曲。
  - 歌曲播放控制通过播放器提供的功能进行（播放、暂停、跳转等）。
  - 进度条显示当前播放的时间，用户可以通过进度条拖动来调整播放进度。

- **歌单管理**：
  - 如果用户是歌单创建者，可以在歌单头部看到“删除歌单”按钮，点击后会弹出确认删除对话框。
  - 用户可以点击“收藏”按钮来收藏或取消收藏当前歌单。
  - 歌单页面上显示所有歌曲，点击单个歌曲项后可以播放该歌曲，也可选择删除该歌曲（如果用户是创建者）。

- **删除歌曲**：
  - 如果用户为歌单创建者，则可以在歌曲列表中删除歌曲。点击歌曲右侧的删除按钮，会触发删除操作。

错误处理与日志

- **错误日志**：
  - 在每个异步请求的 `.then()` 中检查返回的 `code`，如果返回的 `code` 不为 '200'，则通过 `hilog.error()` 输出错误信息。
  - 使用 `try-catch` 捕获请求过程中发生的错误，并记录详细的错误信息。

- **网络请求失败处理**：
  - 如果网络请求失败，相关的歌单数据将无法加载。此时页面展示 "暂无歌单" 或 "加载中..."，并且不会导致应用崩溃。

**CreatePlaylist页面**

主要功能：

- 允许用户输入歌单名称、选择歌单封面来创建歌单
- 展示当前选择的歌单封面和名称

UI组件与交互流程

- 输入歌单名称：用户点击歌单名称输入框，输入歌单名称。
- 选择图片：用户点击选择图片，即可跳转至选择图片的页面。页面使用`PhotoPickerComponent`组件，可以选择用户保存的图片。选择完一张图片后点击“确定”，即可返回创建页面，同时路由参数中包含picUri，使用这个uri去调用`MediaDataHandler`中的`fetchMediaData`方法，即可将uri转化为图片的资源并向后端上传这张图片，并展示刚刚选中的图片
- 点击“创建”即可创建该歌单。

错误日志与处理

- 未选择图片处理：用户点击确定时，如果没有选择任何图片则不会触发返回
- 未获取图片资源处理：资源获取使用try和catch环绕，如果资源获取失败，则会触发报错日志，而不会触发回调导致崩溃。

#### 7、我的页面

主要功能

- **用户信息展示**：显示用户头像和用户名。
- **退出登录**：提供一键退出登录的功能。
- **播放历史记录**：展示用户的播放历史记录，支持右滑删除操作。

实现细节

- **侧滑删除**：
  播放历史记录通过 `List` 组件实现，每个历史记录项使用 `.swipeAction({ end: this.deleteHistory(index) })` 方法添加右滑删除功能。在 `deleteHistory` 函数中，处理删除按钮的 UI 显示和对应的删除逻辑，确保数据的及时更新。

#### 8、搜索

主要功能：

- 搜索内容：输入搜索内容并展示搜索的结果
- 搜索历史：搜索产生搜索历史，点击搜索历史可快速搜索

实现细节：

- 主要逻辑都在SearchPage页面。分为搜索栏和内容
- 进入SearchPage页面时展示搜索历史，根据搜索结果展示“未找到”或“搜索结果”的内容
- 搜索历史历史由本地SQLite数据库做持久化存储
- 其它音乐组件和展示组件与History页面相同

### 服务端

#### 整体概述

采用Springboot作为服务端框架、南大Gitlab代码托管平台

整体采用微服务架构。

- 项目分为多个模块，每个模块保证可独立构建、部署；服务与服务之间使用RestAPI轻量级通信方式进行通信
- 项目微服务包含：
  - Gateway微服务（MainModule）：负责请求转发
  - User微服务：负责用户信息管理、登录注册
  - Tools微服务：负责图片、音乐的数据上传
  - Music微服务：负责音乐的增删查等服务
  - PlayList微服务：负责歌单的增删改查等服务
  - Comment微服务：负责歌曲和歌单的评分评论信息
- 获得请求时，统一由Gateway微服务进行接收，并根据请求内容将请求转发至不同微服务，统一管理并返回

使用南大Gitlab提供的流水线功能，实现持续集成持续部署。

- 代码提交时自动触发流水线
- 流水线分为三个阶段：构建、测试、部署。
  - 构建阶段使用Docker compose将代码使用maven构建并打包为Docker镜像
  - 测试阶段执行单元测试、依赖项检查、静态安全测试
  - 部署阶段将Docker镜像发送给部署服务器并启动Docker容器部署
- 通过设置不同git分支进行开发，仅在提交到main分支时会触发部署，减少项目部署出错的可能性

数据存储：使用MySQL数据库

错误处理：在每个模块中都定义了相应的异常类，所有抛出的异常会被GlobalExceptionHandler捕获，并返回400错误码

### Gateway模块（MainModule）

主要功能：

- 暴露8080端口，对请求进行统一接收转发。
- 使用拦截器Intercepter对请求的身份信息进行检查，实现身份认证
- 通过自定义注解结合AOP切面，指定接口调用需要的用户身份，实现用户鉴权

### User模块

主要功能：

- 实现用户的登录与注册
- 通过JWT机制实现用户身份校验，负责生成和验证JWT，维持登录信息。

### Tools模块

主要功能：

- 与阿里云OSS连接，实现图片、音乐数据的上传

### Music模块

主要功能：

- 实现管理员的音乐添加、删除
- 实现音乐的获取与搜索
- 与Comment微服务进行交流，获取歌曲对应的评分评论

### PlayList模块

主要功能：

- 实现歌单的创建、删除
- 实现歌单中歌曲的添加、删除
- 实现歌单分享、取消分享、收藏、取消收藏

### Comment模块

主要功能：

- 添加、删除评论和评分
- 获取歌曲或歌单的评论或评分

## 二、接口说明文档

接口说明见ApiFox：[MusicPlay](https://app.apifox.com/project/5354385)

项目加入链接： https://app.apifox.com/invite/project?token=C__ketS_vYfalFCBCg3nG